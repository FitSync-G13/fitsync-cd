name: Test AWS Connectivity

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  AWS_REGION: us-east-2

permissions:
  id-token: write
  contents: read

jobs:
  test-connectivity:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActions-FitSync

    - name: Test AWS connectivity
      run: |
        echo "Testing AWS connectivity..."
        aws sts get-caller-identity
        
    - name: List FitSync EC2 instances
      run: |
        echo "Listing FitSync EC2 instances..."
        aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=fitsync" \
          --query 'Reservations[].Instances[].{InstanceId:InstanceId,Name:Tags[?Key==`Name`].Value|[0],Role:Tags[?Key==`Role`].Value|[0],State:State.Name,PrivateIP:PrivateIpAddress}' \
          --output table

    - name: Test SSM connectivity to K3s masters
      run: |
        echo "Testing SSM connectivity to K3s masters..."
        MASTER_INSTANCES=$(aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=fitsync" "Name=tag:Role,Values=k3s-master" "Name=instance-state-name,Values=running" \
          --query 'Reservations[].Instances[].InstanceId' \
          --output text)
        
        if [ -n "$MASTER_INSTANCES" ]; then
          for instance in $MASTER_INSTANCES; do
            echo "Testing SSM connection to $instance..."
            COMMAND_ID=$(aws ssm send-command \
              --instance-ids "$instance" \
              --document-name "AWS-RunShellScript" \
              --parameters 'commands=["echo \"SSM connection successful from GitHub Actions!\"","hostname","whoami","uptime"]' \
              --query 'Command.CommandId' \
              --output text)
            
            echo "Command ID: $COMMAND_ID"
            sleep 5
            
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$instance" \
              --query 'StandardOutputContent' \
              --output text
          done
        else
          echo "No running K3s master instances found"
        fi

    - name: Test SSM connectivity to K3s workers
      run: |
        echo "Testing SSM connectivity to K3s workers..."
        WORKER_INSTANCES=$(aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=fitsync" "Name=tag:Role,Values=k3s-worker" "Name=instance-state-name,Values=running" \
          --query 'Reservations[].Instances[].InstanceId' \
          --output text)
        
        if [ -n "$WORKER_INSTANCES" ]; then
          for instance in $WORKER_INSTANCES; do
            echo "Testing SSM connection to $instance..."
            COMMAND_ID=$(aws ssm send-command \
              --instance-ids "$instance" \
              --document-name "AWS-RunShellScript" \
              --parameters 'commands=["echo \"SSM connection successful from GitHub Actions!\"","hostname","whoami","uptime"]' \
              --query 'Command.CommandId' \
              --output text)
            
            echo "Command ID: $COMMAND_ID"
            sleep 5
            
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$instance" \
              --query 'StandardOutputContent' \
              --output text
          done
        else
          echo "No running K3s worker instances found"
        fi

    - name: Check K3s API Load Balancer
      run: |
        echo "Checking K3s API Load Balancer..."
        aws elbv2 describe-load-balancers \
          --query 'LoadBalancers[?contains(LoadBalancerName, `fitsync`) && contains(LoadBalancerName, `k3s-api`)].{Name:LoadBalancerName,DNS:DNSName,State:State.Code}' \
          --output table
