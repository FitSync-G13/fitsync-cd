name: FitSync K3s Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - 'production'
          - 'staging'
          - 'development'
        default: 'production'
      install_k3s_masters:
        description: 'Install K3s masters'
        required: false
        type: boolean
        default: false
      install_k3s_workers:
        description: 'Install K3s workers'
        required: false
        type: boolean
        default: false
      install_cilium:
        description: 'Install Cilium CNI'
        required: false
        type: boolean
        default: false
      install_istio:
        description: 'Install Istio service mesh'
        required: false
        type: boolean
        default: false
      install_cert_manager:
        description: 'Install cert-manager'
        required: false
        type: boolean
        default: false
      create_wildcard_cert:
        description: 'Create wildcard certificate'
        required: false
        type: boolean
        default: false
      deploy_istio_gateway:
        description: 'Deploy Istio Gateway with HTTPS'
        required: false
        type: boolean
        default: false
      deploy_sample_app:
        description: 'Deploy Bookinfo sample application'
        required: false
        type: boolean
        default: false
      setup_database:
        description: 'Setup PostgreSQL + Redis with TLS'
        required: false
        type: boolean
        default: false
      postgres_version:
        description: 'PostgreSQL version'
        required: false
        type: string
        default: '15'
      redis_version:
        description: 'Redis version'
        required: false
        type: string
        default: '7'

permissions:
  id-token: write
  contents: read

jobs:
  get-infrastructure-info:
    if: ${{ inputs.install_k3s_masters || inputs.install_k3s_workers || inputs.install_cilium || inputs.install_istio || inputs.install_cert_manager || inputs.create_wildcard_cert || inputs.deploy_istio_gateway || inputs.deploy_sample_app || inputs.setup_database }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      master_instances: ${{ steps.get-instances.outputs.master_instances }}
      worker_instances: ${{ steps.get-instances.outputs.worker_instances }}
      k3s_api_dns: ${{ steps.get-instances.outputs.k3s_api_dns }}
    
    steps:
    - name: Setup tools
      run: |
        # Install AWS CLI if not present
        if ! command -v aws &> /dev/null; then
          echo "Installing AWS CLI..."
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          sudo apt-get update && sudo apt-get install -y unzip
          unzip awscliv2.zip
          sudo ./aws/install
        fi
        
        # Install jq if not present
        if ! command -v jq &> /dev/null; then
          echo "Installing jq..."
          sudo apt-get install -y jq
        fi
        
        # Verify installations
        aws --version
        jq --version

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-GetInfraInfo

    - name: Get infrastructure information
      id: get-instances
      run: |
        echo "Getting FitSync infrastructure information for environment: ${{ inputs.environment }}"
        
        # Get master instances
        MASTERS=$(aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=${{ vars.PROJECT_NAME }}" "Name=tag:Role,Values=k3s-master" "Name=tag:Env,Values=${{ vars.SPOKE_ENV }}" "Name=instance-state-name,Values=running" \
          --query 'Reservations[].Instances[].InstanceId' \
          --output text | tr '\t' ',')
        
        # Get worker instances
        WORKERS=$(aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=${{ vars.PROJECT_NAME }}" "Name=tag:Role,Values=k3s-worker" "Name=tag:Env,Values=${{ vars.SPOKE_ENV }}" "Name=instance-state-name,Values=running" \
          --query 'Reservations[].Instances[].InstanceId' \
          --output text | tr '\t' ',')
        
        # Get K3s API load balancer DNS
        K3S_API_DNS=$(aws elbv2 describe-load-balancers \
          --query 'LoadBalancers[?contains(LoadBalancerName, `${{ vars.PROJECT_NAME }}`) && contains(LoadBalancerName, `${{ vars.SPOKE_ENV }}`) && contains(LoadBalancerName, `k3s-api`)].DNSName' \
          --output text)
        
        echo "master_instances=${MASTERS%,}" >> $GITHUB_OUTPUT
        echo "worker_instances=${WORKERS%,}" >> $GITHUB_OUTPUT
        echo "k3s_api_dns=$K3S_API_DNS" >> $GITHUB_OUTPUT
        
        echo "Environment: ${{ inputs.environment }}"
        echo "Masters: ${MASTERS%,}"
        echo "Workers: ${WORKERS%,}"
        echo "K3s API DNS: $K3S_API_DNS"

  install-k3s-masters:
    if: ${{ inputs.install_k3s_masters }}
    needs: get-infrastructure-info
    uses: FitSync-G13/fitsync-cd-templates/.github/workflows/k3s-install-modular.yml@master
    with:
      cluster_name: ${{ vars.PROJECT_NAME }}-${{ inputs.environment }}-cluster
      k3s_version: ''
      master_instances: ${{ needs.get-infrastructure-info.outputs.master_instances }}
      worker_instances: ${{ needs.get-infrastructure-info.outputs.worker_instances }}
      k3s_api_dns: ${{ needs.get-infrastructure-info.outputs.k3s_api_dns }}
      environment: ${{ inputs.environment }}
      install_masters: true
      install_workers: false
      verify_cluster: false
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  install-k3s-workers:
    if: ${{ always() && inputs.install_k3s_workers }}
    needs: [get-infrastructure-info, install-k3s-masters]
    uses: FitSync-G13/fitsync-cd-templates/.github/workflows/k3s-install-modular.yml@master
    with:
      cluster_name: ${{ vars.PROJECT_NAME }}-${{ inputs.environment }}-cluster
      k3s_version: ''
      master_instances: ${{ needs.get-infrastructure-info.outputs.master_instances }}
      worker_instances: ${{ needs.get-infrastructure-info.outputs.worker_instances }}
      k3s_api_dns: ${{ needs.get-infrastructure-info.outputs.k3s_api_dns }}
      environment: ${{ inputs.environment }}
      install_masters: false
      install_workers: true
      verify_cluster: true
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  install-cilium:
    if: ${{ always() && inputs.install_cilium }}
    needs: [get-infrastructure-info, install-k3s-workers]
    uses: FitSync-G13/fitsync-cd-templates/.github/workflows/cilium-install.yml@master
    with:
      cluster_name: ${{ vars.PROJECT_NAME }}-${{ inputs.environment }}-cluster
      master_instances: ${{ needs.get-infrastructure-info.outputs.master_instances }}
      environment: ${{ inputs.environment }}
      cilium_cli_version: ''
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  install-istio:
    if: ${{ always() && inputs.install_istio }}
    needs: [get-infrastructure-info, install-cilium]
    uses: FitSync-G13/fitsync-cd-templates/.github/workflows/istio-install.yml@master
    with:
      cluster_name: ${{ vars.PROJECT_NAME }}-${{ inputs.environment }}-cluster
      master_instances: ${{ needs.get-infrastructure-info.outputs.master_instances }}
      environment: ${{ inputs.environment }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  install-cert-manager:
    if: ${{ always() && inputs.install_cert_manager }}
    needs: [get-infrastructure-info, install-istio]
    uses: FitSync-G13/fitsync-cd-templates/.github/workflows/cert-manager-install.yml@master
    with:
      cluster_name: ${{ vars.PROJECT_NAME }}-${{ inputs.environment }}-cluster
      master_instances: ${{ needs.get-infrastructure-info.outputs.master_instances }}
      environment: ${{ inputs.environment }}
      cert_manager_version: ''
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  create-wildcard-cert:
    if: ${{ always() && inputs.create_wildcard_cert }}
    needs: [get-infrastructure-info, install-cert-manager]
    uses: FitSync-G13/fitsync-cd-templates/.github/workflows/wildcard-cert.yml@master
    with:
      cluster_name: ${{ vars.PROJECT_NAME }}-${{ inputs.environment }}-cluster
      master_instances: ${{ needs.get-infrastructure-info.outputs.master_instances }}
      environment: ${{ inputs.environment }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  deploy-istio-gateway:
    if: ${{ always() && inputs.deploy_istio_gateway }}
    needs: [get-infrastructure-info, create-wildcard-cert]
    uses: FitSync-G13/fitsync-cd-templates/.github/workflows/istio-gateway-https.yml@master
    with:
      cluster_name: ${{ vars.PROJECT_NAME }}-${{ inputs.environment }}-cluster
      master_instances: ${{ needs.get-infrastructure-info.outputs.master_instances }}
      environment: ${{ inputs.environment }}
      domain_name: ${{ vars.DOMAIN_NAME }}
      subdomain_prefix: ${{ vars.SUBDOMAIN_PREFIX || '' }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-sample-app:
    if: ${{ always() && inputs.deploy_sample_app }}
    needs: [get-infrastructure-info, deploy-istio-gateway]
    uses: FitSync-G13/fitsync-cd-templates/.github/workflows/istio-sample-app.yml@master
    with:
      cluster_name: ${{ vars.PROJECT_NAME }}-${{ inputs.environment }}-cluster
      master_instances: ${{ needs.get-infrastructure-info.outputs.master_instances }}
      environment: ${{ inputs.environment }}
      domain_name: ${{ vars.DOMAIN_NAME }}
      subdomain_prefix: ${{ vars.SUBDOMAIN_PREFIX || '' }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  setup-database:
    if: ${{ always() && inputs.setup_database }}
    needs: [get-infrastructure-info]
    uses: FitSync-G13/fitsync-cd-templates/.github/workflows/database-setup.yml@master
    with:
      cluster_name: ${{ vars.PROJECT_NAME }}-${{ inputs.environment }}-cluster
      environment: ${{ inputs.environment }}
      postgres_version: ${{ inputs.postgres_version }}
      redis_version: ${{ inputs.redis_version }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
